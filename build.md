# Сборка проекта

Перед первым запуском сборщика вам нужно определиться, на чем вы будете писать разметку и стили, а также будете ли вы использовать спрайты. 

Первым делом убедитесь, что вы поставили соответствующие npm пакеты из `templates/package.json` (см. [Разворачивание проекта](deployment.md)).

После этого нужно правильно настроить файл `gulp-config.js`. В этом файле собраны базовые настройки для Gulp. Здесь настраиваются: список браузеров для автопрефиксера, расширения картинок для плагина минификации, порт для сокетов и пути до скриптов. Но самыми важными настройками являются: переключение между CSS препроцессорами и подключение Jade и спрайтов.

```js
var config = {
  cssPreprocessor:  'less',  // less || sass || stylus,
  jadePreprocessor: false,   // Подключение Jade
  pngSprites:       false,   // Подключение PNG спрайтов
  svgSprites:       false,   // Подключение SVG спрайтов
};
```

В свойство `cssPreprocessor` передается строка с названием CSS препроцессора, который вы будете использовать: `less`, `sass` или `stylus`. Если значение будет передано неправильно, по умолчанию будет использоваться Less.

Для подключения Jade и спрайтов передайте в соответствующие свойства значение `true`.

Например, вы решили, что будете писать обычный HTML, использовать Stylus в качестве препроцессора и собирать только SVG спрайты. Тогда настройки будут выглядеть следующим образом:

```js
var config = {
  cssPreprocessor:  'stylus',
  jadePreprocessor: false,
  pngSprites:       false,
  svgSprites:       true,
};
```

Эти настройки можно изменить в любой момент. Например, если в начале не планировалось подключать картинки спрайтом, но в последствии заказчик попросил это сделать, нужно просто выполнить порядок, описанный выше: установить нужные npm пакеты (если не установлены), включить сборку спрайтов в `gulp-config.js` и перезапустить сборщик. Другой пример: сначала проект был без движка и верстка велась на jade, затем в проект подключили движок и все изменения стали вносится напрямую в PHP файлы. Таким образом, jade стал не актуален и его можно отключить, чтобы Gulp больше за ним не следил и не собирал.

После настройки `gulp-config.js` можно переходить к запуску задач из `templates/gulpfile.js`. Задачи запускаются в терминале из папки `templates/` по команде `gulp <имя задачи>`. 

## `gulp default` или просто `gulp`

Основная задача сборки на стадии разработки проекта.

* Содержит задачи, упрощающие процесс разработки.
* Следит за изменениями в исходных файлах, при необходимости пересобирает проект.
* Старается не помешать дебагу.
* Запускается 1 раз перед началом сессии разработки.

## `gulp release`

Основная задача сборки на стадии релиза.

* Максимально сжимает все, что можно.
* Старается выпилить все лишнее.

Остальные задачи так же могут запускаться вручную, но обычно в этом нет смысла.

## Добавление новых скриптов

При добавлении новых скриптов в проект, возможно, потребуется обновить какой-то из этих списков в `gulp-config.js`:
- `config.jsInitList` 
- `config.jsMainList`
- `config.jsLibsList` 

После добавления не забудьте перезапустить задачу сборки.

## Build

Результат сборки (в основном) складывается в папке `templates/build/`.

```
templates                           
    ├── build/                      
        ├── css/
            ├── styles.css          # во время разработки
            └── styles.min.css      # в релизной версии подключается в <head>, содержит все стили проекта
        ├── js/
            ├── init.js             # во время разработки
            ├── init.min.js         # в релизной версии подключается сразу после <body>  - содержит инициализирующие скрипты, но иногда требует наличия <body> для манипуляции
            ├── libs.js             # во время разработки
            ├── libs.min.js         # в релизной версии подключаются перед закрытием <body> - содержит js библиотеки
            ├── scripts.js          # во время разработки
            └── scripts.min.js      # в релизной версии подключаются перед закрытием <body> - содержит основные скрипты
        └── images/                 # Минифицированные картинки и спрайты
```

## Возможные проблемы

Если после запуска какого-то таска Gulp выдает ошибку, убедитесь, что у вас установлены нужные модули из списка `optionalDependencies` в `templates/package.json` (см. [Разворачивание проекта](deployment.md)), а также правильно настроен `gulp-config.js`.

