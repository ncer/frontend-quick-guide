# Сборка проекта

Перед первым запуском сборщика вам нужно определиться, на чем вы будете писать разметку и стили, а также будете ли вы использовать спрайты. 

Первым делом убедитесь, что вы поставили соответствующие npm пакеты из `templates/package.json` (см. [Разворачивание проекта](deployment.md)).

После этого нужно правильно настроить файл `gulp-config.js`. В этом файле собраны базовые настройки для Gulp.

```js
// Основные настройки
var config = {
  cssPreprocessor:  'less',                    // CSS препроцессор (less || sass || stylus)
  jadePreprocessor: false,                     // Подключение Jade
  pngSprites:       false,                     // Подключение PNG спрайтов
  svgSprites:       false,                     // Подключение SVG спрайтов
  jsLinter:         true,                      // JS линтер (не рекомендуется отключать)
  cms:              false,                     // Используется ли сборка в составе движка
  browsers:         ['last 2 versions'],       // Список браузеров для автопрефиксера (настраивается индивидуально для каждого проекта)
  imageExtensions:  '.{jpg,jpeg,png,gif,svg}', // Расширения картинок для плагина минификации
  port:             81                         // Порт для сокетов
};

// Пути для файлов
...
// Список инициализирующих скриптов и библиотек, которые помещаются в начало <body/>
config.jsInitList = [...]
// Список js библиотек, которые помещаются в конце <body/>
config.jsLibsList= [...]
// Список скриптов, которые пишем сами и которые помещаются в конце <body/>
config.jsMainList= [...]

// См. подробности в самом файле
```

Остановимся подробнее на некоторых настройках.

В свойство `cssPreprocessor` передается строка с названием CSS препроцессора, который вы будете использовать: `less`, `sass` или `stylus`. Если значение будет передано неправильно, по умолчанию будет использоваться Less.

Для подключения Jade и спрайтов передайте в соответствующие свойства значение `true`.

Например, вы решили, что будете писать обычный HTML, использовать Stylus в качестве препроцессора и собирать только SVG спрайты. Тогда настройки будут выглядеть следующим образом:

```js
var config = {
  cssPreprocessor:  'stylus',
  jadePreprocessor: false,
  pngSprites:       false,
  svgSprites:       true,
};
```

Все настройки можно изменить в любой момент. Например, если в начале не планировалось подключать картинки спрайтом, но в последствии заказчик попросил это сделать, нужно просто выполнить порядок, описанный выше: установить нужные npm пакеты (если не установлены), включить сборку спрайтов в `gulp-config.js` и перезапустить сборщик. Другой пример: сначала проект был без движка и верстка велась на jade, затем в проект подключили движок и все изменения стали вносится напрямую в PHP файлы. Таким образом, jade стал не актуален и его можно отключить, чтобы Gulp больше за ним не следил и не собирал.

После настройки `gulp-config.js` можно переходить к запуску задач из `templates/gulpfile.js`. Задачи запускаются в терминале из папки `templates/` по команде `gulp <имя задачи>`. 

## `gulp default` или просто `gulp`

Основная задача сборки на стадии разработки проекта.

* Содержит задачи, упрощающие процесс разработки.
* Следит за изменениями в исходных файлах, при необходимости пересобирает проект.
* Старается не помешать дебагу.
* Запускается 1 раз перед началом сессии разработки.

## `gulp release`

Основная задача сборки на стадии релиза.

* Максимально сжимает все, что можно.
* Старается выпилить все лишнее.

Остальные задачи так же могут запускаться вручную, но обычно в этом нет смысла.

## Добавление новых скриптов

При добавлении новых скриптов в проект, возможно, потребуется обновить какой-то из этих списков в `gulp-config.js`:
- `config.jsInitList` 
- `config.jsMainList`
- `config.jsLibsList` 

После добавления не забудьте перезапустить задачу сборки.

## Build

Результат сборки (в основном) складывается в папке `templates/build/`.

Здесь следует упомянуть о флаге `cms` в `gulp-config.js`. Он влияет на то, как будут минифицироваться CSS и JS файлы в папке `templates/build` при запуске команды `gulp release`. Если передано значение `true`, то код будет сжат в отдельные `*.min` файлы (`style.css => style.min.css`). Этот способ можно использовать только на движке, где есть возможность определять боевой сервер и скармливать нужные файлы. Если в `cms` передано `false`, код будет сжат в тех же файлах (`style.css => style.css`). В этом случае нужно не забывать всегда после коммита выполнять `gulp release`, иначе на продакшен улетят несжатые файлы!

Структура `templates/build/` при `cms = true`:

```
templates                           
    ├── build/                      
        ├── css/
            ├── styles.css      # во время разработки
            └── styles.min.css  # в релизной версии
        ├── js/
            ├── init.js         # во время разработки
            ├── init.min.js     # в релизной версии
            ├── libs.js         # во время разработки
            ├── libs.min.js     # в релизной версии
            ├── scripts.js      # во время разработки
            └── scripts.min.js  # в релизной версии
        └── images/             # минифицированные картинки и спрайты
```

Структура `templates/build/` при `cms = false`:

```
templates                           
    ├── build/                      
        ├── css/
            └── styles.css      # всегда
        ├── js/
            ├── init.js         # всегда
            ├── libs.js         # всегда
            └── scripts.js      # всегда
        └── images/             # минифицированные картинки и спрайты

```

## Возможные проблемы

Если после запуска какого-то таска Gulp выдает ошибку, убедитесь, что у вас установлены нужные модули из списка `optionalDependencies` в `templates/package.json` (см. [Разворачивание проекта](deployment.md)), а также правильно настроен `gulp-config.js`.

